name: Deploy to Aptible

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Set VUE environment variables HERE for build time
      VUE_APP_TITLE: "WOUNDMED INC."
      VUE_APP_API_URL: "https://woundmed.on-aptible.com"
      VUE_APP_BASE_URL: "https://woundmed.on-aptible.com"
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build Vue.js Frontend
        working-directory: ./frontend
        env:
          # Pass the variables again explicitly to the Vue build step
          VUE_APP_TITLE: ${{ env.VUE_APP_TITLE }}
          VUE_APP_API_URL: ${{ env.VUE_APP_API_URL }}
          VUE_APP_BASE_URL: ${{ env.VUE_APP_BASE_URL }}
        run: |
          echo "Building Vue.js with environment variables:"
          echo "VUE_APP_TITLE: $VUE_APP_TITLE"
          echo "VUE_APP_API_URL: $VUE_APP_API_URL"
          echo "VUE_APP_BASE_URL: $VUE_APP_BASE_URL"
          
          npm ci
          npm run build
          
          # Copy to Laravel public directory
          mkdir -p ../backend/public
          cp -r dist/* ../backend/public/
          
          # Verify build
          ls -la ../backend/public/

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, zip, exif, pcntl, gd, mysql, pdo_mysql
          coverage: none

      - name: Prepare Laravel Backend
        working-directory: ./backend
        env:
          # Optional: Set APP_KEY for Laravel build if needed
          APP_KEY: ${{ secrets.APP_KEY }}
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction
          php artisan storage:link
          php artisan optimize:clear

      - name: Deploy to Aptible
        uses: aptible/aptible-deploy-action@v4
        with:
          type: git
          app: woundmed
          environment: woundmed_environment
          username: ${{ secrets.APTIBLE_USERNAME }}
          password: ${{ secrets.APTIBLE_PASSWORD }}
          # Runtime environment variables (for Aptible)
          env: |
            # These are for runtime in Aptible
            VUE_APP_TITLE=WOUNDMED INC.
            VUE_APP_API_URL=https://woundmed.on-aptible.com
            VUE_APP_BASE_URL=https://woundmed.on-aptible.com
            # Add other runtime variables from your Aptible Environment Variables